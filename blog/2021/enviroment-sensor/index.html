<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Environment Sensor with Display | Alex Hay</title> <meta name="author" content="Alex Hay"/> <meta name="description" content="An Arduino Project"/> <meta name="keywords" content="robotics, neuroscience, engineering, mechanics"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/favicon.png"/> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://xeroblaze0.github.io/blog/2021/enviroment-sensor/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span>Alex&nbsp;</span>Hay</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item active"> <a class="nav-link" href="/blog/">Projects<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Environment Sensor with Display</h1> <p class="post-meta">June 21, 2021</p> <p class="post-tags"> <a href="/blog/2021"> <i class="fas fa-calendar fa-sm"></i> 2021 </a> &nbsp; &middot; &nbsp; <a href="/blog/tag/arduino"> <i class="fas fa-hashtag fa-sm"></i> arduino</a> &nbsp; <a href="/blog/tag/sensors"> <i class="fas fa-hashtag fa-sm"></i> sensors</a> &nbsp; <a href="/blog/tag/embedded-systems"> <i class="fas fa-hashtag fa-sm"></i> embedded-systems</a> &nbsp; </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Initially developed as a automation tool for gardening, this device monitors qualities of air, light, and soil in its environment.</p> <hr/> <h2 id="overview">Overview</h2> <p>The purpose of this device is to monitor its environment. It measures air pressure, temperature, humidity, volatile organic compounds (VOCs), ambient light luminosity, crude spectral analysis, and soil moisture. The exterior shell is 3D printed PLA, folded into its final shape. It’s controlled, and powered, using an Arduino Nano Sense BLE.</p> <h3 id="peripherals">Peripherals</h3> <p>The device takes advantage of several sensors, external and onboard, and a screen to display the information on. Below is a description of each:</p> <ul> <li><a href="https://learn.adafruit.com/adafruit-bme680-humidity-temperature-barometic-pressure-voc-gas/overview">BME680 Air Quality Sensor</a> <ul> <li>Temperature, pressure, humidity, VOCs</li> <li>I2C/SPI</li> <li>Requires calibration</li> </ul> </li> <li><a href="https://learn.adafruit.com/adafruit-tsl2591">TSL2591 HDR Light Sensor</a> <ul> <li>Luminosity</li> <li>I2C</li> <li>Contains IR diodes</li> </ul> </li> <li><a href="https://www.adafruit.com/product/1918">GUVA UV Sensor</a> <ul> <li>UVB/UVA (240-370nm)</li> <li>Analog</li> </ul> </li> <li><a href="https://www.adafruit.com/product/3595">ADPS9960 Light Sensor</a> <ul> <li>RGB color sensing</li> <li>Onboard Arduino Sense</li> <li>Contains IR detectors</li> </ul> </li> <li><a href="https://wiki.dfrobot.com/Capacitive_Soil_Moisture_Sensor_SKU_SEN0193">DFRobot Soil Sensor</a> <ul> <li>Capacitive moisture sensing</li> <li>Analog</li> <li>Requires calibration</li> </ul> </li> <li><a href="https://wiki.dfrobot.com/1.54%20Inches%20240_240_IPS_TFT_LCD_Display_with_MicroSD_Card_Breakout_SKU_DFR0649">ST7789 1.54” TFT Display</a> <ul> <li>240x240 pixels</li> <li>SPI communication</li> </ul> </li> </ul> <h3 id="enclosure">Enclosure</h3> <p>I decided to work with a folding assembly technique. This makes mounting the sensors easy in a small space while also simplifying the design. Below is an early shot of the foldable layout.</p> <p> <center><img src="/assets/enviro_sensor/img/foldy_face.png" width="80%;" height="100%;" alt=""/> <br/> <em>Figure 1: 3D model of enclosure</em></center> </p> <h2 id="control">Control</h2> <p>A few libraries need to be included for the sensors to operate. I found Adafruit’s display library easier to use than DFRobot’s. Some of the sensors need to be initialized beforehand, notably the VOC. It’s recommended that it run for 30 mins while in use. “This is because the sensitivity levels of the sensor will change during early use and the resistance will slowly rise over time as the MOX warms up to its baseline reading.” - <a href="https://learn.adafruit.com/adafruit-bme680-humidity-temperature-barometic-pressure-voc-gas/overview">Adafruit BME680 Overview</a>. For this reasion, the device has a 5 minute warm-up period before displaying VOC data.</p> <blockquote> <p>` bme.setGasHeater(320, 150); // 320*C for 150 ms`</p> </blockquote> <p>Likewise, the TSL2591 has a special initialization parameters:</p> <blockquote> <p>` void configureTSL2591(void){`</p> <p>` tsl.setGain(TSL2591_GAIN_MED); // 25x gain<code class="language-plaintext highlighter-rouge"> </code> tsl.setTiming(TSL2591_INTEGRATIONTIME_300MS);<code class="language-plaintext highlighter-rouge"> </code> tsl2591Gain_t gain = tsl.getGain();`</p> <p><code class="language-plaintext highlighter-rouge">}</code></p> </blockquote> <p>The controller assumes the TSL2591 and the APDS9960 have the same spectral response. First, the TSL2591 has two photodiodes: Visible spectrum + Infrared (VS+IR) response, and Infrared (IR) response. Subtracting the IR photodiode activity from the VS+IR activity leaves visible light. See Figure 2, left.</p> <p>Spectral responses are different, but similar enough to each other for this trick to work. The ADPS9960 might exhibit more activity towards the lowered end of the spectrum. Even though we’re strictly using the RGB channels, this will present a slight bias towards blue later in the project.</p> <div class="img_row"> <img class="col two" src="/assets/enviro_sensor/img/tsl2591_spectrum.png"/> <img class="col two" src="/assets/enviro_sensor/img/apds9960_spectrum.png" style="float: right"/> </div> <div class="col three caption"> Figure 2: left, TSL2591 spectral response; right, onboard APDS9960 spectral response </div> <p>The GUVA UV wavelength response is ~240-380nm, just out of reach of the APDS9960. Because of this, there’s no way to estimate how much luminosity is in the UV range<sup>*</sup>. This is a good excuse for a better UV sensor!</p> <h6>I didn't know of a way off hand and left it at that.</h6> <div class="img_row"> <img class="col three" src="/assets/enviro_sensor/img/guva_spectrum.png"/> </div> <div class="col three caption"> Figure 3: GUVA responsivity curve </div> <p>From here, we normalize color activity by dividing each color channel by the sum of all color channels:</p> <blockquote> <p>red % = r/(r+g+b)</p> <p>green % = g/(r+g+b)</p> <p>blue % = b/(r+g+b)</p> </blockquote> <p>We use these values with the visible light data to give us RGB luminosity data. With this and the IR luminosity data earlier, we can make a “full spectrum” wavelength response graph.</p> <p> <center><img src="/assets/enviro_sensor/img/screen.png" width="80%;" height="100%;" alt=""/> <br/> <em>Figure 4: Spectral data displayed on screen</em></center> </p> <p><br/> We’ll never know why I took screenshots instead of saving the original responsivity figures</p> </div> </article></div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> &copy; Copyright 2024 Alex Hay. Powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>. Last updated: August 21, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>